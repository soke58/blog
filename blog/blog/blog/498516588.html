<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>vb 程序只允许一个实例运行</title></head><body><h1>vb 程序只允许一个实例运行</h1><div><p><table><tbody><tr><td><div>Private Sub Form_Load() <br />If App.PrevInstance Then <br />End <br />End If <br />End Sub <br /><br /><br /><br /><br /><br />用DDE实现窗体防止运行多个实例并传递命令 <br /><br />上网的朋友一定都用过网络蚂蚁（Net Ants）的吧？不知你在使用过程中有没有注意过，那就是如果你想调动两个“蚂蚁”为您效力是不可能的——它总会把新运行的关闭。这点在VB中很容易实现： <br /><br />Private Sub Form_Load() <br />If App.PrevInstance Then <br />MsgBox &quot;你已经运行这个应用程序了&quot; <br />End ' 退出新运行的程序 <br />End If <br />End Sub <br /><br />这样如果你运行这个程序后在运行它，它会弹出一个消息框并拒绝再次运行。这非常容易。 而“蚂蚁”程序的妙处就在于：在重复运行“蚂蚁”时它不仅拒绝运行，而且能把已经运行的“蚂蚁”激活，这样用上面的程序就无能为力了。但事实上实现拒绝运行并激活已运行的 <br />程序有多种方法： <br /><br />1、用FindWindow函数得到已经运行窗体的句柄（HWND），然后用SetActiveWindow等API函数将其激活。其缺点也很明显，那就是没法传递参数。 <br /><br />2、用FindWindow函数得到已运行窗体的句柄后用SendMessage的方法给窗体传送一个自定义消息（附带参数），然后在窗体中拦截并进行处理，但这样做要修改窗体的标准消息处理程序，用在VC，BC或DELPHI编写的程序中还行，但在VB中工作量太大，并且容易发生“一般保护行错误”使VB崩溃，不太可取（当然，如果你有足够的信心和不怕崩溃的精神，也可以试一下 ^_^ ）。 <br /><br />3、使用DDE技术。 <br /><br />所谓DDE技术，就是动态数据交换技术。也许你很奇怪，这与本文所讨论的内容有什么相干的？ <br />且听我慢慢讲来。 <br />为了实现拒绝运行并把已经运行的程序激活并实现各种功能，我们可以先用本文开头提到的方法，检测一下程序有没有被运行过，如果没有，就正常运行，如果已经被运行过，就打通与它的DDE通道，传给它一个（或一些）数据，然后由已经运行的程序对数据进行处理，再去实现各种“意想不到”的功能，这时也许就有人对这你的程序喊：“酷、酷……” ^_^ <br /><br />好了，耳听为虚，眼见为实，下面让我们动点真格的。 <br /><br />打开VB，新建一个工程，选择菜单中的“工程-&gt;工程1 属性”，把工程名称改为“P1”（我爱偷懒，能短则短 ^_^ ），把已有的一个窗体的“LinkTopic”属性改为“FormDDE”，把“LinkMode”属性改为“1 - Source”，添加一个PictureBox控件作为DDE执行控件，命名为picDDE。然后添加一个TextBox控件，命名为“txtInfo”，并把“MultiLine”属性设置为“True”，以便显示多行文本，作为消息显示控件。 <br /><br />最后在窗体代码区输入以下代码： <br /><br /><br />Const COMMANDLINE = &quot;CommandLine=&quot; ' 还是为了省事，定义一个常量 <br /><br />Private Sub Form_LinkExecute(CmdStr As String, Cancel As Integer) <br />Static lngCount As Long <br />Dim Info As String <br /><br />Info = txtInfo.Text ' 保留原有信息 <br /><br />Select Case CmdStr ' CmdStr 是DDE程序传送过来的参数 <br />Case &quot;Max&quot; <br />Me.WindowState = 2 <br />Info = Info + vbNewLine + &quot;窗体已被最大化&quot; <br />Case &quot;ShowTime&quot; <br />Info = Info + vbNewLine + &quot;最后一次运行这个程序的时间是：&quot; + Str(Now) <br />Case &quot;Count&quot; <br />lngCount = lngCount + 1 <br />Info = Info + vbNewLine + &quot;你已经第&quot; + Str(lngCount) + &quot;次重复调用这个程序。&quot; _ <br />+ vbNewLine + &quot;但怕您不多给工资，所以只运行了一个 ^_^&quot; <br />End Select <br /><br />If Left(CmdStr, Len(COMMANDLINE)) = COMMANDLINE Then <br />Info = Info + vbNewLine + &quot;新程序曾以命令行形式运行&quot; + vbNewLine + &quot;命令行为：&quot; _ <br />+ vbNewLine + Right(CmdStr, Len(CmdStr) - Len(COMMANDLINE)) <br />End If <br /><br />txtInfo.Text = Info ' 把信息显示出来 <br /><br />Cancel = False <br />End Sub <br /><br /><br />Private Sub LinkAndSendMessage(ByVal Msg As String) <br />Dim t As Long <br />picDDE.LinkMode = 0 '-- <br />picDDE.LinkTopic = &quot;P1|FormDDE&quot; ' |______连接DDE程序并发送数据/参数 <br />picDDE.LinkMode = 2 ' | “|”为管道符，是“退格键”旁边的竖线， <br />picDDE.LinkExecute Msg '-- 不是字母或数字！ <br /><br />t = picDDE.LinkTimeout '-- <br />picDDE.LinkTimeout = 1 ' |______终止DDE通道。当然，也可以用别的方法 <br />picDDE.LinkMode = 0 ' | 这里用的是超时强制终止的方法 <br />picDDE.LinkTimeout = t '-- <br />End Sub <br /><br /><br />Private Sub Form_Load() <br />If App.PrevInstance Then ' 程序是否已经运行 <br /><br />Me.LinkTopic = &quot;&quot; ' 这两行用于清除新运行的程序的DDE服务器属性， <br />Me.LinkMode = 0 ' 否则在连接DDE程序时会出乱子的 <br /><br />LinkAndSendMessage &quot;Max&quot; '-- <br />LinkAndSendMessage &quot;Count&quot; ' |-----连接DDE接受程序并传送数据/参数 <br />LinkAndSendMessage &quot;ShowTime&quot; '-- <br /><br />If Command &lt;&gt; &quot;&quot; Then ' 如果有命令行参数，就传递过去 <br />LinkAndSendMessage COMMANDLINE + Command <br />End If <br />End ' 结束新程序的运行 <br />End If <br />End Sub <br /><br />测试一下： <br />把工程“P1”编译成EXE文件（设名称为 P1.EXE ） <br />1、打开“我的电脑”，找到 P1.EXE 并执行。可以看到程序正常运行了。 <br />2、再运行一次，这次新程序没有运行成功，而原来运行的程序却被最大化了，而且文本框中有以下 <br />字符： <br /><br />窗体已被最大化 <br />你已经第 1次重复调用这个程序。 <br />但怕您不多给工资，所以只运行了一个 ^_^ <br />最后一次运行这个程序的时间是：00-2-6 7:11:01 <br /><br />3、打开 MS-DOS方式 ，用命令行方式再次运行程序，如 “P1 How Are You?” <br />这时原来运行的程序文本框中又多了几行字： <br /><br />窗体已被最大化 <br />你已经第 2次重复调用这个程序。 <br />但怕您不多给工资，所以只运行了一个 ^_^ <br />最后一次运行这个程序的时间是：00-2-6 7:14:32 <br />新程序曾以命令行形式运行 <br />命令行为： <br />How Are You? <br /><br />OK，运行完全正确，然后你就可以把它应用的你的程序中了。</div></td></tr></tbody></table><br /></p></div></body></html>